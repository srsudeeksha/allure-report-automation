name: Frontend & Allure Report Deployment

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install frontend dependencies
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      # 4ï¸âƒ£ Build the frontend app
      - name: Build frontend
        run: npm run build
        working-directory: frontend

      # 5ï¸âƒ£ Run Vitest tests with Allure (preserve history)
      - name: Run Vitest tests with Allure
        run: |
          mkdir -p frontend/allure-results/history
          if [ -d "frontend/allure-report/history" ]; then
            echo "ðŸ“ Copying previous Allure history..."
            cp -r frontend/allure-report/history frontend/allure-results/
          fi

          echo "ðŸ§ª Running tests and generating Allure results..."
          npm run test:allure

          echo "ðŸ“Š Generating Allure report..."
          npx allure generate frontend/allure-results --clean -o frontend/allure-report
        working-directory: frontend

      # 6ï¸âƒ£ Prepare combined deployment folder (frontend + Allure report)
      - name: Prepare deployment folder
        run: |
          mkdir -p public/allure-report
          cp -r frontend/dist/* public/
          cp -r frontend/allure-report/* public/allure-report/

      # 7ï¸âƒ£ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          force_orphan: true

      # 8ï¸âƒ£ Deployment summary
      - name: Show Deployment URLs
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend App:**" >> $GITHUB_STEP_SUMMARY
          echo "- [View App](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Allure Report:**" >> $GITHUB_STEP_SUMMARY
          echo "- [View Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/)" >> $GITHUB_STEP_SUMMARY
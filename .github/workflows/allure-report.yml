name: Frontend & Allure Report Deployment

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install frontend dependencies
      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      # 4ï¸âƒ£ Build frontend app
      - name: Build frontend
        run: npm run build
        working-directory: frontend

      # 5ï¸âƒ£ Fetch previous gh-pages branch for allure-history
      - name: Fetch existing gh-pages (for allure-history)
        run: |
          git fetch origin gh-pages --depth=1
          mkdir -p old-gh-pages
          git worktree add old-gh-pages gh-pages || true

      # 6ï¸âƒ£ Copy old allure-history to keep history
      - name: Restore allure history
        run: |
          mkdir -p frontend/allure-report/history
          if [ -d "old-gh-pages/allure-history" ]; then
            cp -r old-gh-pages/allure-history frontend/allure-report/history || true
          fi

      # 7ï¸âƒ£ Run Vitest tests with Allure
      - name: Run Vitest tests
        run: npm run test:allure
        working-directory: frontend

      # 8ï¸âƒ£ Prepare combined deployment folder
      - name: Prepare deployment folder
        run: |
          mkdir -p public/allure-report public/allure-history
          cp -r frontend/dist/* public/
          cp -r frontend/allure-report/* public/allure-report/
          cp -r frontend/allure-report/history/* public/allure-history/ || true

      # 9ï¸âƒ£ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          force_orphan: true

      # ðŸ”Ÿ Display Deployment URLs
      - name: Show Deployment URLs
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend App:**" >> $GITHUB_STEP_SUMMARY
          echo "- [View App](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Allure Report (Today):**" >> $GITHUB_STEP_SUMMARY
          echo "- [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Allure History (Past Reports):**" >> $GITHUB_STEP_SUMMARY
          echo "- [View History](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-history/)" >> $GITHUB_STEP_SUMMARY

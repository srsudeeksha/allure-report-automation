name: Frontend & Allure Report Deployment

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install frontend dependencies
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      # 4ï¸âƒ£ Build the frontend app
      - name: Build frontend
        run: npm run build
        working-directory: frontend

      # 5ï¸âƒ£ Run Vitest tests with Allure
      - name: Run Vitest tests
        run: npm run test:allure
        working-directory: frontend

      # 6ï¸âƒ£ Prepare deployment folders
      - name: Prepare combined deployment folder
        run: |
          DATE=$(date +'%Y-%m-%d-%H-%M-%S')

          # Create required directories
          mkdir -p public/allure-report
          mkdir -p public/allure-history

          # Copy frontend build
          cp -r frontend/dist/* public/

          # Preserve previous reports in allure-history
          if [ -d public/allure-report ]; then
            mv public/allure-report/* public/allure-history/ || true
          fi

          # Copy todayâ€™s report into allure-report
          cp -r frontend/allure-report/* public/allure-report/

          # Save timestamp marker
          echo "$DATE" > public/allure-report/generated_on.txt

      # 7ï¸âƒ£ Deploy to GitHub Pages (preserve old history)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          keep_files: true
          commit_message: "Auto-deploy: frontend + allure reports ($(date +'%Y-%m-%d %H:%M:%S'))"

      # 8ï¸âƒ£ Display deployment summary
      - name: Show Deployment URLs
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend App:**" >> $GITHUB_STEP_SUMMARY
          echo "- [View App](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Today's Allure Report:**" >> $GITHUB_STEP_SUMMARY
          echo "- [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All Previous Reports (Archive):**" >> $GITHUB_STEP_SUMMARY
          echo "- [Allure History](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-history/)" >> $GITHUB_STEP_SUMMARY
